<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Bad Apple</title>

    <style>
        body {
            background: #000;
            color: #fff;
            font-family: monospace;
            text-align: center;
        }
    </style>
</head>
<body>
    <script>
        const frames = []
        
        window.onload = function() {
            const audio = document.getElementById('audio')
            const volumeInput = document.getElementById('volume')
            const element = document.getElementById('output')

            audio.volume = 0.2
            volumeInput.value = audio.volume * 100

            volumeInput.oninput = function() {
                audio.volume = (volumeInput.value / 100)
            }

            let i = 0;
            asyncLoop(22, (loop) => {
                fetch(`chunks/chunk${i}.html`)
                    .then(data => {
                        return data.text()
                    })
                    .then(data => {
                        const chunk = data.split('---END OF FRAME---')
                        const chunkFrames = []
                        
                        chunk.forEach(frame => {
                            frame.length > 0 && frames.push(frame)
                        })
                        
                        i++
                        loop.next()
                    })                       
            }, () => {
                console.log('load complete!')
                document.getElementById('audio').play()
                startAnimation(element)
            })      
        };

        let j = 0
        function startAnimation(element) {
            let interval = setInterval(() => {
                if(j > frames.length) {
                    clearInterval(interval)
                } else {
                    element.innerHTML = frames[j]
                    j++
                }
                
            }, 41.6666666667)
        }

    function asyncLoop(iterations, func, callback) {
        var index = 0;
        var done = false;
        var loop = {
            next: function() {
                if (done) {
                    return;
                }

                if (index < iterations) {
                    index++;
                    func(loop);

                } else {
                    done = true;
                    callback();
                }
            },

            iteration: function() {
                return index - 1;
            },

            break: function() {
                done = true;
                callback();
            }
        };
        loop.next();
        return loop;
    }
    </script>

    <h1>Bad Apple text version</h1>

    <pre id="output">Loading...</pre>
    <audio id="audio">
        <source src="audio.ogg" type="audio/ogg">
        Your browser does not support the audio tag.
    </audio>
    <span style="vertical-align: super; ">Volume:</span> 
    <input id="volume" type="range">
    <p>Checkout my <a href="http://github.com/k-egor-smirnov">GitHub</a> to find more my intresting projects</p>
    <p><a href="http://github.com/k-egor-smirnov/bad-apple">Bad Apple repository</a></p>
</body>
</html>